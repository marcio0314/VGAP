groups:
  - name: vgap-alerts
    rules:
      # API Health
      - alert: VGAPApiDown
        expr: up{job="vgap-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "VGAP API is down"
          description: "The VGAP API server has been down for more than 1 minute."

      # Database Health
      - alert: VGAPDatabaseDown
        expr: pg_up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL database is down"
          description: "The PostgreSQL database has been unavailable for more than 1 minute."

      # Redis Health
      - alert: VGAPRedisDown
        expr: redis_up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis is down"
          description: "Redis has been unavailable for more than 1 minute."

      # No Active Workers
      - alert: VGAPNoActiveWorkers
        expr: vgap_celery_workers_active == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "No active Celery workers"
          description: "There have been no active Celery workers for more than 5 minutes. Pipeline processing is paused."

      # High Error Rate
      - alert: VGAPHighErrorRate
        expr: rate(vgap_http_requests_total{status=~"5.."}[5m]) / rate(vgap_http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API error rate"
          description: "More than 5% of API requests are failing."

      # Slow Response Time
      - alert: VGAPSlowResponse
        expr: histogram_quantile(0.95, rate(vgap_http_request_duration_seconds_bucket[5m])) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Slow API response time"
          description: "95th percentile response time is over 5 seconds."

      # Disk Space Low
      - alert: VGAPDiskSpaceLow
        expr: vgap_disk_usage_percent > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Disk space is running low"
          description: "Disk usage is above 85%. Consider cleaning up old runs or expanding storage."

      # Disk Space Critical
      - alert: VGAPDiskSpaceCritical
        expr: vgap_disk_usage_percent > 95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Disk space critically low"
          description: "Disk usage is above 95%. New runs may fail due to insufficient space."

      # Pipeline Stuck
      - alert: VGAPPipelineStuck
        expr: vgap_pipeline_running_duration_seconds > 7200
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Pipeline run appears stuck"
          description: "A pipeline run has been in 'running' status for more than 2 hours."

      # High Memory Usage
      - alert: VGAPWorkerHighMemory
        expr: process_resident_memory_bytes{job="vgap-worker"} > 4e9
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Worker memory usage is high"
          description: "Celery worker is using more than 4GB of memory."

      # Many Failed Runs
      - alert: VGAPManyFailedRuns
        expr: increase(vgap_runs_total{status="failed"}[1h]) > 5
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "Multiple pipeline failures"
          description: "More than 5 pipeline runs have failed in the last hour."

      # Database Connection Pool Exhausted
      - alert: VGAPDatabasePoolExhausted
        expr: pg_stat_activity_count > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "PostgreSQL has more than 90 active connections."

      # Queue Backlog
      - alert: VGAPQueueBacklog
        expr: vgap_celery_queue_length > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Large queue backlog"
          description: "More than 100 tasks are waiting in the Celery queue."
